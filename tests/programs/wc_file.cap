package safe
module wc_file
use sys.system
use sys.console
use sys.args
use sys.fs
use sys.string
use sys.bytes
use sys.buffer
use sys.vec

fn count_text(c: Console, s: string) -> i32 {
  let buf = string.bytes(s)
  let bytes = bytes.len(buf)
  let words_vec = string.split_whitespace(s)
  let words = vec.vec_string_len(words_vec)
  let alloc = buffer.alloc_default()
  vec.vec_string_free(alloc, words_vec)
  let i: i32 = 0
  let lines: i32 = 0
  while (i < bytes) {
    let b = bytes.at(buf, i)
    if (b == 10u8) {
      lines = lines + 1
    }
    i = i + 1
  }
  console.print_i32(c, lines)
  console.print(c, " ")
  console.print_i32(c, words)
  console.print(c, " ")
  console.print_i32(c, bytes)
  console.println(c, "")
  return 0
}

pub fn main(sys: System) -> i32 {
  let c = system.console(sys)

  if (args.len(sys) < 2) {
    console.println(c, "usage: wc <path>")
    return 1
  }

  let code = match args.at(sys, 1) {
    Ok(path) => {
      let rfs = system.fs_read(sys, "./")
      match fs.read_to_string(rfs, path) {
        Ok(s) => { count_text(c, s) }
        Err(e) => {
          console.println(c, "read err")
          1
        }
      }
    }
    Err(e) => {
      console.println(c, "arg err")
      1
    }
  }

  return code
}

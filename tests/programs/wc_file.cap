package safe
module wc_file
use sys::system
use sys::console
use sys::buffer

fn count_text(sys: RootCap, c: Console, alloc: Alloc, s: string) -> i32 {
  let buf = s.bytes()
  let bytes = buf.len()
  let words_vec = s.split_whitespace()
  let words = words_vec.len()
  alloc.vec_string_free(words_vec)
  let i: i32 = 0
  let lines: i32 = 0
  while (i < bytes) {
    let b = buf.at(i)
    if (b == 10u8) {
      lines = lines + 1
    }
    i = i + 1
  }
  sys.assert(lines == 8 && words == 19 && bytes == 128)
  c.print_i32(lines)
  c.print(" ")
  c.print_i32(words)
  c.print(" ")
  c.print_i32(bytes)
  c.println("")
  return 0
}

pub fn main(sys: RootCap) -> i32 {
  let c = sys.mint_console()

  if (sys.args_len() < 2) {
    c.println("usage: wc <path>")
    return 1
  }

  let code = match sys.args_at(1) {
    Ok(path) => {
      let rfs = sys.mint_readfs("./")
      match rfs.read_to_string(path) {
        Ok(s) => {
          let alloc = sys.mint_alloc_default()
          count_text(sys, c, alloc, s)
        }
        Err(e) => {
          c.println("read err")
          1
        }
      }
    }
    Err(e) => {
      c.println("arg err")
      1
    }
  }

  return code
}

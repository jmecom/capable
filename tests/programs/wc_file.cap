package safe
module wc_file
use sys::root
use sys::console
use sys::args
use sys::fs
use sys::string
use sys::bytes
use sys::buffer
use sys::vec

fn count_text(c: Console, s: string) -> i32 {
  let buf = s.bytes()
  let bytes = buf.len()
  let words_vec = s.split_whitespace()
  let words = words_vec.len()
  let alloc = buffer.alloc_default()
  vec.vec_string_free(alloc, words_vec)
  let i: i32 = 0
  let lines: i32 = 0
  while (i < bytes) {
    let b = buf.at(i)
    if (b == 10u8) {
      lines = lines + 1
    }
    i = i + 1
  }
  c.print_i32(lines)
  c.print(" ")
  c.print_i32(words)
  c.print(" ")
  c.print_i32(bytes)
  c.println("")
  return 0
}

pub fn main(rc: RootCap) -> i32 {
  let c = rc.mint_console()
  let a = rc.mint_args()

  if (a.len() < 2) {
    c.println("usage: wc <path>")
    return 1
  }

  let code = match a.at(1) {
    Ok(path) => {
      let rfs = rc.mint_fs_read("./")
      match rfs.read_to_string(path) {
        Ok(s) => { count_text(c, s) }
        Err(e) => {
          c.println("read err")
          1
        }
      }
    }
    Err(e) => {
      c.println("arg err")
      1
    }
  }

  return code
}

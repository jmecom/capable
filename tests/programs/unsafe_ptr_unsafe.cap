package unsafe
module unsafe_ptr_unsafe
use sys::buffer
use sys::unsafe_ptr
use sys::system

pub fn main(rc: RootCap) -> i32 {
  let c = rc.mint_console()
  let alloc = rc.mint_alloc_default()
  let size = unsafe_ptr::sizeof<u8>()
  let align = unsafe_ptr::alignof<u8>()
  c.assert(size == 1)
  c.assert(align == 1)
  let raw = alloc.malloc(4)
  unsafe_ptr::ptr_write<u8>(raw, 42u8)
  unsafe_ptr::ptr_write<u8>(unsafe_ptr::ptr_add<u8>(raw, 1), 7u8)
  unsafe_ptr::ptr_write<u8>(unsafe_ptr::ptr_add<u8>(raw, 2), 9u8)
  let v = unsafe_ptr::ptr_read<u8>(raw)
  c.assert(v == 42u8)
  let raw2 = alloc.malloc(4)
  unsafe_ptr::memcpy<u8>(raw2, raw, 4)
  let v2 = unsafe_ptr::ptr_read<u8>(raw2)
  let v3 = unsafe_ptr::ptr_read<u8>(unsafe_ptr::ptr_add<u8>(raw2, 2))
  c.assert(v2 == 42u8)
  c.assert(v3 == 9u8)
  unsafe_ptr::memmove<u8>(unsafe_ptr::ptr_add<u8>(raw2, 1), raw2, 3)
  let v4 = unsafe_ptr::ptr_read<u8>(unsafe_ptr::ptr_add<u8>(raw2, 1))
  c.assert(v4 == 42u8)
  alloc.free(raw)
  alloc.free(raw2)
  c.println("unsafe ptr ok")
  return 0
}

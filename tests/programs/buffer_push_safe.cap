package safe
module buffer_push_safe
use sys::system

pub fn main(rc: RootCap) -> i32 {
  let c = rc.mint_console()
  let alloc = rc.mint_alloc_default()
  match alloc.buffer_new(1) {
    Ok(b) => {
      match b.push('\x07') {
        Ok(u) => { u }
        Err(e) => {
          c.println("push err")
          alloc.buffer_free(b)
          return 1
        }
      }
      let v = alloc.vec_u8_new()
      match v.push('\t') {
        Ok(u) => { u }
        Err(e) => {
          c.println("vec err")
          alloc.vec_u8_free(v)
          alloc.buffer_free(b)
          return 1
        }
      }
      let slice = v.as_slice()
      match b.extend(slice) {
        Ok(u) => { u }
        Err(e) => {
          c.println("extend err")
          alloc.vec_u8_free(v)
          alloc.buffer_free(b)
          return 1
        }
      }
      let len = b.len()
      c.assert(len == 3)
      c.assert(!b.is_empty())
      if (len == 3) {
        c.println("push ok")
      } else {
        c.println("push bad")
      }
      alloc.vec_u8_free(v)
      alloc.buffer_free(b)
      return 0
    }
    Err(e) => {
      c.println("buffer err")
      return 1
    }
  }
}
